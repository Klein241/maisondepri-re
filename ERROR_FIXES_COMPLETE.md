# ğŸ”§ Error Fixes - Complete Guide

This document explains all the errors you're experiencing and provides comprehensive fixes.

---

## ğŸ“‹ **Summary of Errors**

### âŒ **Critical Errors** (Need immediate fix)
1. **Storage Upload Errors**: "new row violates row-level security policy"
2. **Prayer Request Insert Errors**: 400 Bad Request from database

### âš ï¸ **Warnings** (Non-critical but should fix)
3. **Cookie Warning**: `__cf_bm` cookie rejected
4. **Font Preloading Warnings**: Next.js font optimization warnings
5. **Accessibility Warning**: Missing Description for DialogContent

---

## ğŸš¨ **CRITICAL ERROR #1: Storage RLS Policy Violations**

### Error Message:
```
Upload error: StorageApiError: new row violates row-level security policy
```

### Root Cause:
Your Supabase Storage buckets **don't have Row-Level Security (RLS) policies** configured. By default, RLS blocks all operations unless explicitly allowed.

### Affected Buckets:
- `prayer-photos`
- `testimony-photos` 
- `testimonial-photos`
- `day-resources`
- `avatars`
- `prayers`
- `testimonials`
- `resources`

### âœ… **Solution:**

#### **Option 1: Run SQL Script in Supabase (RECOMMENDED)**

1. Open your Supabase Dashboard
2. Go to **SQL Editor**
3. Copy the entire contents of `fix_storage_rls_policies.sql`
4. Paste and click **RUN**

This will:
- âœ… Create all missing storage buckets
- âœ… Set up proper RLS policies for authenticated users
- âœ… Allow uploads, reads, updates, and deletes

#### **Option 2: Manual Configuration in Dashboard**

For each bucket (`prayer-photos`, `testimony-photos`, etc.):

1. Go to **Storage** > **Policies**
2. Click **New Policy**
3. Create these 4 policies:

**Policy 1: SELECT (View)**
```sql
(bucket_id = 'prayer-photos')
```

**Policy 2: INSERT (Upload)**
```sql
(bucket_id = 'prayer-photos' AND auth.role() = 'authenticated')
```

**Policy 3: UPDATE (Modify)**
```sql
(bucket_id = 'prayer-photos' AND auth.role() = 'authenticated')
```

**Policy 4: DELETE (Remove)**
```sql
(bucket_id = 'prayer-photos' AND auth.role() = 'authenticated')
```

Repeat for all other buckets.

---

## ğŸš¨ **CRITICAL ERROR #2: Prayer Request Insert Failures**

### Error Message:
```
POST https://[your-supabase-url]/rest/v1/prayer_requests?columns="user_id","content"... 
[HTTP/2 400]
```

### Root Cause:
The columns being sent don't match the database schema, or there are validation errors.

### âœ… **Solution:**

Check the component that's inserting prayer requests. The error shows:
```
columns="user_id","content","is_anonymous","category","photos","created_at"
```

**Potential Issues:**
1. **`created_at` should NOT be in INSERT** - It's auto-generated by the database
2. **Missing required fields** - Make sure all NOT NULL fields are included
3. **Type mismatches** - Ensure data types match schema

#### Fix the insert query:

Remove `created_at` from the columns list:
```typescript
const { data, error } = await supabase
  .from('prayer_requests')
  .insert({
    user_id: user.id,
    content: content,
    is_anonymous: isAnonymous,
    category: category,
    photos: photoUrls // Should be an array of strings
    // Don't include created_at - it's auto-generated
  })
  .select();
```

---

## âš ï¸ **WARNING #3: Cookie Policy Violation**

### Error Message:
```
Le cookie Â« __cf_bm Â» a Ã©tÃ© rejetÃ© car le domaine est invalide. websocket
```

### Root Cause:
Cloudflare's bot management cookie (`__cf_bm`) is trying to set on websocket connections.

### Impact:
**Non-critical** - This doesn't affect functionality. It's a browser security warning.

### âœ… **Solution:**
No action needed. This is expected behavior when using Supabase Realtime with Cloudflare in front.

If you want to suppress it:
- Use Supabase's direct connection URL instead of going through Cloudflare
- Or ignore it (recommended)

---

## âš ï¸ **WARNING #4: Font Preloading**

### Error Messages:
```
La ressource Ã  l'adresse Â« http://localhost:3000/_next/static/media/115e7a2565b70400-s.p.e440a306.woff2 Â» 
prÃ©chargÃ©e avec le prÃ©chargement de lien n'a pas Ã©tÃ© utilisÃ©e aprÃ¨s quelques secondes.
```

### Root Cause:
Next.js is preloading fonts that may not be used immediately on the page.

### Impact:
**Non-critical** - Minor performance warning, doesn't affect functionality.

### âœ… **Solution:**
No action needed. This is a Next.js optimization warning and can be safely ignored in development.

---

## âš ï¸ **WARNING #5: Missing Accessibility Description**

### Error Message:
```
Warning: Missing `Description` or `aria-describedby={undefined}` for {DialogContent}
```

### Root Cause:
The `DialogContent` component needs either:
- A `DialogDescription` child component
- An `aria-describedby` attribute

### Impact:
**Accessibility issue** - Screen readers won't have proper context.

### âœ… **Solutions:**

#### **Option A: Add DialogDescription** (Recommended)

Find all `DialogContent` components and add `DialogDescription`:

```tsx
<DialogContent>
  <DialogHeader>
    <DialogTitle>Nouveau tÃ©moignage</DialogTitle>
    <DialogDescription>
      Partagez votre tÃ©moignage avec la communautÃ©
    </DialogDescription>
  </DialogHeader>
  {/* Rest of content */}
</DialogContent>
```

#### **Option B: Add aria-describedby**

If you don't want visible description:

```tsx
<DialogContent aria-describedby="dialog-description">
  <DialogHeader>
    <DialogTitle>Nouveau tÃ©moignage</DialogTitle>
  </DialogHeader>
  <p id="dialog-description" className="sr-only">
    Partagez votre tÃ©moignage avec la communautÃ©
  </p>
  {/* Rest of content */}
</DialogContent>
```

#### **Files needing updates:**
Based on the console warning count ("2"), these files likely need fixes:
- `src/components/views/journal-view.tsx` (lines 144, 277)
- `src/components/community/add-testimonial-dialog.tsx` (line 153)
- `src/app/admin/users/page.tsx` (lines 315, 695)
- `src/app/admin/content/page.tsx` (lines 311, 568)

---

## ğŸ¯ **Priority Action Plan**

### **Step 1: Fix Storage RLS (HIGHEST PRIORITY)** âš¡
```bash
# Run this SQL script in Supabase SQL Editor
fix_storage_rls_policies.sql
```

### **Step 2: Fix Prayer Request Inserts** ğŸ”§
- Remove `created_at` from insert columns
- Verify all data types match schema
- Check user authentication

### **Step 3: Fix Accessibility Warnings** â™¿
- Add `DialogDescription` to all dialogs
- Or add `aria-describedby` attributes

### **Step 4: Ongoing** ğŸ“Š
- Monitor console for any new errors
- Test file uploads after RLS fix
- Test prayer request creation

---

## ğŸ§ª **Testing Checklist**

After applying fixes, test these features:

- [ ] Upload photo to testimony form âœ…
- [ ] Upload photo to prayer request âœ…
- [ ] Submit prayer request âœ…
- [ ] Create new testimonial âœ…
- [ ] Upload avatar image âœ…
- [ ] Admin upload day resources âœ…
- [ ] No console errors on page load âœ…
- [ ] Screen reader can read dialogs âœ…

---

## ğŸ“Š **Expected Results**

### Before Fixes:
```
âŒ Upload error: StorageApiError: new row violates row-level security policy
âŒ POST prayer_requests [HTTP/2 400]
âš ï¸  Warning: Missing Description for DialogContent
```

### After Fixes:
```
âœ… Photo uploaded successfully
âœ… Prayer request submitted
âœ… No accessibility warnings
```

---

## ğŸ”— **Related Files**

- `fix_storage_rls_policies.sql` - Complete Storage RLS fix
- `supabase-complete-v2.sql` - Full database schema
- `src/components/ui/photo-upload.tsx` - Photo upload component
- `src/components/ui/dialog.tsx` - Dialog component definition

---

## ğŸ’¡ **Additional Notes**

### Database RLS vs Storage RLS
- **Database RLS**: Controls data access in tables (already configured âœ…)
- **Storage RLS**: Controls file access in buckets (needed fixing âŒ)

### Why Storage RLS is Separate
Supabase Storage has its own RLS system that's independent from database tables. You need to configure both separately.

### Security Best Practices
The RLS policies we've created:
- âœ… Allow authenticated users to upload their own files
- âœ… Allow anyone to view public content
- âœ… Prevent anonymous uploads
- âœ… Use `auth.role()` for proper security

---

## ğŸ†˜ **Need More Help?**

If you still have errors after applying these fixes:

1. **Check Supabase Logs**: Dashboard > Logs > All logs
2. **Verify User Authentication**: Make sure `auth.uid()` returns a valid ID
3. **Test with SQL Editor**: Run test queries directly in Supabase
4. **Check Network Tab**: Look for detailed error responses

---

## âœ… **Summary**

| Error | Severity | Fixed? | File |
|-------|----------|--------|------|
| Storage RLS violation | ğŸ”´ Critical | âœ… Yes | `fix_storage_rls_policies.sql` |
| Prayer request 400 | ğŸ”´ Critical | ğŸ“ Instructions | See above |
| Cookie warning | ğŸŸ¡ Minor | N/A | Ignore |
| Font preload | ğŸŸ¡ Minor | N/A | Ignore |
| Accessibility | ğŸŸ¡ Minor | ğŸ“ Instructions | See above |

**Next Step**: Run the SQL script in Supabase to fix storage uploads! ğŸš€
