================================================================================
üö® INSTRUCTIONS OBLIGATOIRES POUR L'IA ‚Äî LIRE EN PRIORIT√â AVANT TOUT D√âVELOPPEMENT
================================================================================

Ce fichier est destin√© √† tout mod√®le IA (Claude, GPT, Gemini, etc.) qui intervient
sur ce projet. Il contient des r√®gles CRITIQUES qui prot√®gent l'application contre
un probl√®me financier grave d√©j√† rencontr√© et r√©solu en f√©vrier 2026.

================================================================================
üìñ CONTEXTE ‚Äî CE QUI S'EST PASS√â
================================================================================

En f√©vrier 2026, l'application "Maison de Pri√®re" a consomm√© la totalit√© de ses
cr√©dits Netlify (125 000 invocations gratuites, puis 1000 cr√©dits payants) en
quelques jours seulement, avec seulement ~50 utilisateurs actifs.

CAUSE DU PROBL√àME :
L'application utilisait Next.js en mode SSR (Server-Side Rendering) avec le plugin
@netlify/plugin-nextjs. Chaque visite de page et chaque appel d'API invoquait une
"Netlify Serverless Function", factur√©e en cr√©dits :

  - 1 visite de page = 1 cr√©dit (SSR)
  - 1 appel API /api/group-messages = 1 cr√©dit
  - Le polling du chat (toutes les 8 secondes) = 450 cr√©dits/heure/utilisateur
  - 1 appel /api/bible = 1 cr√©dit
  - 1 appel /api/auth/ensure-profile = 1 cr√©dit

R√©sultat : un seul utilisateur actif sur le chat consommait ~938 cr√©dits/jour.
Pour 50 utilisateurs = ~47 000 cr√©dits/jour = budget √©puis√© en 2-3 jours.

================================================================================
‚úÖ LA SOLUTION MISE EN PLACE ‚Äî EXPORT STATIQUE (SPA)
================================================================================

L'application a √©t√© convertie en EXPORT STATIQUE Next.js :

  - next.config.ts ‚Üí output: 'export'
  - Le build g√©n√®re un dossier "out/" avec des fichiers HTML/JS/CSS purs
  - Netlify sert ces fichiers comme un CDN classique ‚Üí 0 cr√©dit consomm√©
  - TOUTES les donn√©es sont charg√©es c√¥t√© CLIENT via le SDK Supabase
  - AUCUNE route API serverless n'existe dans le projet
  - Le temps r√©el utilise Supabase Realtime (WebSocket c√¥t√© client)

R√©sultat : 0 cr√©dit consomm√© par visite, 0 par message, 0 par utilisateur.
L'application peut supporter des milliers d'utilisateurs sur le plan GRATUIT.

================================================================================
üö´ CE QUE TU NE DOIS JAMAIS FAIRE
================================================================================

1. ‚ùå NE JAMAIS cr√©er de dossier "src/app/api/"
   ‚Üí Les routes API Next.js cr√©ent des serverless functions sur Netlify
   ‚Üí Chaque appel = 1 cr√©dit Netlify factur√©
   ‚Üí C'est LA CAUSE du probl√®me de surconsommation

2. ‚ùå NE JAMAIS supprimer ou modifier "output: 'export'" dans next.config.ts
   ‚Üí Sans cette option, Next.js utilise le SSR (Server-Side Rendering)
   ‚Üí Chaque visite de page = 1 serverless function = 1 cr√©dit

3. ‚ùå NE JAMAIS installer ou configurer "@netlify/plugin-nextjs"
   ‚Üí Ce plugin active le mode SSR de Next.js sur Netlify
   ‚Üí C'est lui qui transforme chaque page en serverless function

4. ‚ùå NE JAMAIS utiliser ces fonctions/imports dans les pages :
   ‚Üí import { headers, cookies } from 'next/headers'
   ‚Üí import { NextRequest, NextResponse } from 'next/server'
   ‚Üí export const dynamic = "force-dynamic"
   ‚Üí export const dynamicParams = true
   ‚Üí Ces √©l√©ments forcent le rendu serveur

5. ‚ùå NE JAMAIS cr√©er de routes dynamiques [param] sans generateStaticParams()
   ‚Üí Les routes dynamiques sans params statiques cassent le build
   ‚Üí La route admin/users/[id] a √©t√© supprim√©e pour cette raison

6. ‚ùå NE JAMAIS utiliser fetch('/api/...') dans les composants
   ‚Üí Il n'y a plus de routes API dans ce projet
   ‚Üí Utilise les fonctions dans src/lib/api-client.ts √† la place

================================================================================
‚úÖ CE QUE TU DOIS FAIRE √Ä LA PLACE
================================================================================

1. ‚úÖ Pour charger des donn√©es ‚Üí Utiliser le SDK Supabase DIRECTEMENT
   
   Exemple :
   ```typescript
   import { supabase } from '@/lib/supabase';
   
   const { data, error } = await supabase
     .from('prayer_requests')
     .select('*')
     .order('created_at', { ascending: false });
   ```

2. ‚úÖ Pour les op√©rations CRUD ‚Üí Utiliser api-client.ts ou direct Supabase
   
   Les fonctions r√©utilisables sont dans :
   - src/lib/api-client.ts ‚Üí loadGroupMessages, sendGroupMessage, 
                              ensureUserProfile, fetchBiblePassage
   - src/lib/admin-client.ts ‚Üí adminDeleteContent, adminCreateUser, 
                                adminDeleteUser

3. ‚úÖ Pour le temps r√©el ‚Üí Utiliser Supabase Realtime (d√©j√† en place)
   
   ```typescript
   const channel = supabase
     .channel('my-channel')
     .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, 
         (payload) => { /* mise √† jour */ })
     .subscribe();
   ```

4. ‚úÖ Si une logique serveur est ABSOLUMENT n√©cessaire ‚Üí Supabase Edge Functions
   
   Les Supabase Edge Functions sont GRATUITES et ILLIMIT√âES.
   - Cr√©er dans : supabase/functions/nom-fonction/index.ts
   - D√©ployer : supabase functions deploy nom-fonction
   - Appeler : supabase.functions.invoke('nom-fonction', { body: {...} })
   
   NE PAS cr√©er de API route Next.js (/api/...) pour cela !

5. ‚úÖ Pour les nouvelles pages ‚Üí Composants client avec "use client"
   
   ```typescript
   "use client"
   import { useState, useEffect } from 'react';
   import { supabase } from '@/lib/supabase';
   
   export default function MaPage() {
     const [data, setData] = useState([]);
     useEffect(() => {
       supabase.from('table').select('*').then(({ data }) => setData(data || []));
     }, []);
     return <div>{/* rendu */}</div>;
   }
   ```

================================================================================
üìÇ STRUCTURE DU PROJET ‚Äî FICHIERS CL√âS
================================================================================

next.config.ts          ‚Üí CONTIENT output: 'export' (NE PAS MODIFIER)
netlify.toml            ‚Üí publish = "out", SPA fallback redirect
src/lib/supabase.ts     ‚Üí Client Supabase (singleton)
src/lib/api-client.ts   ‚Üí Fonctions de data-fetching (remplacent les API routes)
src/lib/admin-client.ts ‚Üí Fonctions admin (remplacent les API admin routes)
src/app/               ‚Üí Pages de l'application (toutes statiques)
src/app/api/           ‚Üí ‚ö†Ô∏è CE DOSSIER NE DOIT PAS EXISTER

================================================================================
üîí S√âCURIT√â ‚Äî RLS SUPABASE
================================================================================

Puisque TOUTES les requ√™tes passent directement du navigateur √† Supabase,
les Row Level Security (RLS) policies sont le SEUL m√©canisme de s√©curit√©.

Avant de cr√©er une nouvelle table ou de modifier les acc√®s :
1. V√©rifier que la table a des RLS policies activ√©es
2. V√©rifier que les policies autorisent UNIQUEMENT ce qui est n√©cessaire
3. Ne JAMAIS d√©sactiver RLS sur une table contenant des donn√©es sensibles

================================================================================
üìä R√âSUM√â EN UNE PHRASE
================================================================================

"Ce projet est un SITE STATIQUE Next.js. TOUTES les donn√©es passent par le SDK
Supabase C√îT√â CLIENT. Il n'y a AUCUNE route API serverless. Ne jamais en cr√©er."

================================================================================
